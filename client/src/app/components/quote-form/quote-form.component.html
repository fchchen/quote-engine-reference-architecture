<div class="quote-form-container">
  <h1>Get a Quote</h1>

  <mat-stepper [linear]="true" #stepper>
    <!-- Step 1: Business Information -->
    <mat-step [stepControl]="businessForm" label="Business Info">
      <div class="step-content">
        <h2>Business Information</h2>
        <p class="step-description">
          Search for an existing business or enter new information.
        </p>

        <app-business-search
          [resetTrigger]="searchResetTrigger()"
          (businessSelected)="onBusinessSelected($event)">
        </app-business-search>

        <mat-divider></mat-divider>

        <form [formGroup]="businessForm">
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Business Name</mat-label>
              <input matInput formControlName="businessName" required>
              @if (businessForm.get('businessName')?.hasError('required')) {
                <mat-error>Business name is required</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Tax ID</mat-label>
              <input matInput formControlName="taxId" placeholder="XX-XXXXXXX" required>
              @if (businessForm.get('taxId')?.hasError('required')) {
                <mat-error>Tax ID is required</mat-error>
              } @else if (businessForm.get('taxId')?.hasError('pattern')) {
                <mat-error>Format: XX-XXXXXXX</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Business Type</mat-label>
              <mat-select formControlName="businessType" required>
                @for (type of businessTypes(); track type.type) {
                  <mat-option [value]="type.type">{{ type.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>State</mat-label>
              <mat-select formControlName="stateCode" required>
                @for (state of states(); track state.code) {
                  <mat-option [value]="state.code">{{ state.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Years in Business</mat-label>
              <input matInput type="number" formControlName="yearsInBusiness" min="1">
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Number of Employees</mat-label>
              <input matInput type="number" formControlName="employeeCount" min="1">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Annual Revenue</mat-label>
              <span matTextPrefix>$ </span>
              <input matInput type="number" formControlName="annualRevenue">
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Annual Payroll</mat-label>
              <span matTextPrefix>$ </span>
              <input matInput type="number" formControlName="annualPayroll">
            </mat-form-field>
          </div>
        </form>

        <div class="button-row">
          <button mat-raised-button color="primary" matStepperNext
                  [disabled]="!businessForm.valid">
            Next
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 2: Coverage Selection -->
    <mat-step [stepControl]="coverageForm" label="Coverage">
      <div class="step-content">
        <h2>Coverage Options</h2>

        <form [formGroup]="coverageForm">
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Product Type</mat-label>
              <mat-select formControlName="productType" required>
                @for (product of products(); track product.type) {
                  <mat-option [value]="product.type">{{ product.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Classification Code</mat-label>
              <mat-select formControlName="classificationCode">
                @for (code of classificationCodes(); track code.code) {
                  <mat-option [value]="code.code">
                    {{ code.code }} - {{ code.description }}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Coverage Limit</mat-label>
              <mat-select formControlName="coverageLimit">
                <mat-option [value]="300000">$300,000</mat-option>
                <mat-option [value]="500000">$500,000</mat-option>
                <mat-option [value]="1000000">$1,000,000</mat-option>
                <mat-option [value]="2000000">$2,000,000</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>Deductible</mat-label>
              <mat-select formControlName="deductible">
                <mat-option [value]="500">$500</mat-option>
                <mat-option [value]="1000">$1,000</mat-option>
                <mat-option [value]="2500">$2,500</mat-option>
                <mat-option [value]="5000">$5,000</mat-option>
                <mat-option [value]="10000">$10,000</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Effective Date</mat-label>
            <input matInput type="date" formControlName="effectiveDate">
          </mat-form-field>

          <!-- Dynamic Fields based on Product Type -->
          @for (field of dynamicFields(); track field.key + '-' + currentBusinessId()) {
            <app-dynamic-field
              [config]="field"
              [value]="getDynamicFieldValue(field.key)"
              (valueChange)="setDynamicFieldValue(field.key, $event)">
            </app-dynamic-field>
          }
        </form>

        <!-- Premium Estimate -->
        @if (premiumEstimate()) {
          <mat-card class="estimate-card">
            <mat-card-content>
              <div class="estimate-display">
                <span class="estimate-label">Estimated Premium</span>
                <span class="estimate-amount">
                  {{ premiumEstimate()!.estimatedAnnualPremium | currency }}
                </span>
                <span class="estimate-note">per year</span>
              </div>
            </mat-card-content>
          </mat-card>
        }

        <div class="button-row">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" matStepperNext
                  [disabled]="!coverageForm.valid">
            Next
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 3: Risk Factors (Optional) -->
    <mat-step label="Risk Factors" [optional]="true">
      <div class="step-content">
        <h2>Additional Risk Information</h2>
        <p class="step-description">
          Providing this information may help improve your quote.
        </p>

        <app-risk-factors
          [resetTrigger]="riskFactorsResetTrigger()"
          [initialFactors]="riskFactors()"
          (factorsChange)="onRiskFactorsChange($event)">
        </app-risk-factors>

        <div class="button-row">
          <button mat-button matStepperPrevious>Back</button>
          <button mat-raised-button color="primary" matStepperNext>
            Next
          </button>
        </div>
      </div>
    </mat-step>

    <!-- Step 4: Review & Submit -->
    <mat-step label="Review">
      <div class="step-content">
        <h2>Review & Submit</h2>

        @if (quoteService.isLoading()) {
          <div class="loading-container">
            <mat-spinner diameter="60"></mat-spinner>
            <p>Calculating your quote...</p>
          </div>
        } @else if (quoteService.currentQuote()) {
          <app-quote-result
            [quote]="quoteService.currentQuote()!"
            (save)="onSaveQuote($event)"
            (bind)="onBindQuote($event)">
          </app-quote-result>
          <div class="button-row">
            <button mat-raised-button color="accent" (click)="startNewQuote()">
              <mat-icon>add</mat-icon>
              Start New Quote
            </button>
          </div>
        } @else {
          <!-- Review Summary -->
          <mat-card class="review-card">
            <mat-card-header>
              <mat-card-title>Quote Summary</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="review-section">
                <h4>Business</h4>
                <p>{{ businessForm.get('businessName')?.value }}</p>
                <p>{{ businessForm.get('stateCode')?.value }} | {{ getBusinessTypeName() }}</p>
              </div>

              <div class="review-section">
                <h4>Coverage</h4>
                <p>{{ getProductTypeName() }}</p>
                <p>Limit: {{ coverageForm.get('coverageLimit')?.value | currency }}</p>
                <p>Deductible: {{ coverageForm.get('deductible')?.value | currency }}</p>
              </div>

              @if (premiumEstimate()) {
                <div class="review-section estimate">
                  <h4>Estimated Premium</h4>
                  <p class="estimate-amount">
                    {{ premiumEstimate()!.estimatedAnnualPremium | currency }}/year
                  </p>
                </div>
              }
            </mat-card-content>
          </mat-card>

          @if (quoteService.error()) {
            <div class="error-message">
              <mat-icon>error</mat-icon>
              {{ quoteService.error() }}
            </div>
          }

          <div class="button-row">
            <button mat-button matStepperPrevious>Back</button>
            <button mat-raised-button color="primary"
                    (click)="submitQuote()"
                    [disabled]="!businessForm.valid || !coverageForm.valid">
              <mat-icon>calculate</mat-icon>
              Get Final Quote
            </button>
          </div>
        }
      </div>
    </mat-step>
  </mat-stepper>
</div>
